{{ define "main" }}
<article class="article-full">
    <header class="article-header">
        <h1 class="article-title">{{ .Title }}</h1>
        <div class="article-meta">
            <span><i class="fa-solid fa-calendar"></i> {{ .Date.Format "2006-01-02" }}</span>
            <span><i class="fa-solid fa-clock"></i> {{ .ReadingTime }} 分钟阅读</span>
            <span><i class="fa-solid fa-user"></i> {{ .Site.Params.author | default "作者" }}</span>
            {{ with .Params.categories }}
            <span><i class="fa-solid fa-folder"></i> {{ range . }}{{ . }}{{ end }}</span>
            {{ end }}
        </div>
    </header>

    <!-- 标题管理器 -->
    <div class="toc-float">
        <div class="toc-toggle" id="toc-toggle">
            <i class="fa-solid fa-list"></i>
            <span>目录</span>
        </div>
        <div class="toc-content" id="toc-content">
            <div class="toc-header">
                <span><i class="fa-solid fa-book"></i> 文章目录</span>
                <i class="fa-solid fa-times toc-close" id="toc-close"></i>
            </div>
            <div class="toc-list" id="toc-list">
                <!-- 目录内容由JavaScript生成 -->
            </div>
        </div>
    </div>

    <div class="article-content">
        {{ .Content }}
    </div>

    <footer class="article-footer">
        <div class="article-tags">
            {{ with .Params.tags }}
            <span><i class="fa-solid fa-tags"></i> 标签:</span>
            {{ range . }}
            <a href="{{ "/tags/" | relURL }}{{ . | urlize }}" class="tag">{{ . }}</a>
            {{ end }}
            {{ end }}
        </div>

        <div class="article-share">
            <span><i class="fa-solid fa-share-nodes"></i> 分享:</span>
            <a href="#" onclick="shareToTwitter()" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
            <a href="#" onclick="shareToFacebook()" title="Facebook"><i class="fa-brands fa-facebook"></i></a>
            <a href="#" onclick="shareToWeibo()" title="微博"><i class="fa-brands fa-weibo"></i></a>
        </div>

        <!-- 上一篇/下一篇 -->
        <div class="article-nav">
            {{ with .PrevInSection }}
            <a href="{{ .RelPermalink }}" class="nav-btn nav-prev">
                <i class="fa-solid fa-arrow-left"></i>
                <span>上一篇</span>
                <span class="nav-title">{{ .Title }}</span>
            </a>
            {{ end }}
            {{ with .NextInSection }}
            <a href="{{ .RelPermalink }}" class="nav-btn nav-next">
                <i class="fa-solid fa-arrow-right"></i>
                <span>下一篇</span>
                <span class="nav-title">{{ .Title }}</span>
            </a>
            {{ end }}
        </div>
    </footer>
</article>

<!-- Related Posts -->
{{ $related := .Site.RegularPages.Related . | first 3 }}
{{ with $related }}
<div class="related-posts">
    <h3><i class="fa-solid fa-link"></i> 相关文章</h3>
    <div class="related-posts-grid">
        {{ range . }}
        <div class="related-post">
            <h4><a href="{{ .RelPermalink }}">{{ .Title }}</a></h4>
            <p>{{ .Summary }}</p>
        </div>
        {{ end }}
    </div>
</div>
{{ end }}
{{ end }}

{{ define "scripts" }}
<script>
function shareToTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(document.title);
    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
}

function shareToFacebook() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareToWeibo() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(document.title);
    window.open(`https://service.weibo.com/share/share.php?title=${text}&url=${url}`, '_blank');
}

// ==================== 目录功能 ====================
function initTOC() {
    const articleContent = document.querySelector('.article-content');
    if (!articleContent) return;

    const tocList = document.getElementById('toc-list');
    const tocToggle = document.getElementById('toc-toggle');
    const tocContent = document.getElementById('toc-content');
    const tocClose = document.getElementById('toc-close');

    if (!tocList || !tocToggle || !tocContent || !tocClose) return;

    // 提取所有标题
    const headings = articleContent.querySelectorAll('h1, h2, h3, h4, h5, h6');

    // 即使没有标题也显示目录，只是目录为空

    // 构建目录结构
    const tocData = [];
    const stack = [{ level: 0, children: tocData }];

    headings.forEach((heading) => {
        const level = parseInt(heading.tagName.charAt(1));
        const text = heading.textContent.trim();
        const anchorDiv = heading.querySelector('.anchor');
        const anchorId = anchorDiv ? anchorDiv.id : '';

        const item = {
            level: level,
            text: text,
            anchor: anchorId,
            children: []
        };

        // 根据层级调整父级
        while (stack.length > 1 && stack[stack.length - 1].level >= level) {
            stack.pop();
        }

        const parent = stack[stack.length - 1];
        parent.children.push(item);
        stack.push({ level: level, children: item.children });
    });

    // 渲染目录
    function renderTOC(items, container, currentLevel) {
        if (items.length === 0) return;

        const ul = document.createElement('ul');
        ul.className = 'toc-level-' + currentLevel;

        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'toc-item toc-level-' + item.level;

            const a = document.createElement('a');
            a.href = '#' + item.anchor;
            a.textContent = item.text;
            a.className = 'toc-link';

            if (item.anchor) {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // 防止触发其他点击事件
                    const target = document.getElementById(item.anchor);
                    if (target) {
                        // 获取主内容区域的滚动容器
                        const mainContent = document.getElementById('main-content');
                        const offset = 100;
                        
                        // 计算目标元素相对于主内容区域的位置
                        const targetRect = target.getBoundingClientRect();
                        const mainRect = mainContent.getBoundingClientRect();
                        const relativeTop = targetRect.top - mainRect.top + mainContent.scrollTop - offset;
                        
                        // 在主内容区域内滚动
                        mainContent.scrollTo({
                            top: Math.max(0, relativeTop),
                            behavior: 'smooth'
                        });
                        
                        // 关闭目录面板
                        tocContent.classList.remove('active');
                        const icon = tocToggle.querySelector('i');
                        icon.className = 'fa-solid fa-list';
                    }
                });
            }

            li.appendChild(a);

            if (item.children.length > 0) {
                renderTOC(item.children, li, item.level + 1);
            }

            ul.appendChild(li);
        });

        container.appendChild(ul);
    }

    renderTOC(tocData, tocList, 1);

    // 切换显示/隐藏
    tocToggle.addEventListener('click', (e) => {
        // 如果正在拖动，不触发点击
        if (tocFloat && tocFloat.dataset.isDragging === 'true') {
            return;
        }
        tocContent.classList.toggle('active');
        const icon = tocToggle.querySelector('i');
        icon.className = tocContent.classList.contains('active') ?
            'fa-solid fa-times' : 'fa-solid fa-list';
    });

    tocClose.addEventListener('click', () => {
        tocContent.classList.remove('active');
        const icon = tocToggle.querySelector('i');
        icon.className = 'fa-solid fa-list';
    });

    // 点击外部关闭
    document.addEventListener('click', (e) => {
        if (!tocContent.contains(e.target) && !tocToggle.contains(e.target)) {
            tocContent.classList.remove('active');
            const icon = tocToggle.querySelector('i');
            icon.className = 'fa-solid fa-list';
        }
    });

    // ==================== 目录拖动功能 ====================
    const tocFloat = document.querySelector('.toc-float');
    if (tocFloat) {
        let isDragging = false;
        let startX, startY, initialRight, initialTop;
        let hasMoved = false;

        // 从localStorage读取保存的位置
        const savedPosition = localStorage.getItem('tocPosition');
        if (savedPosition) {
            const pos = JSON.parse(savedPosition);
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                const mainRect = mainContent.getBoundingClientRect();
                // 确保保存的位置在阅读区内
                const clampedLeft = Math.max(mainRect.left + 10, Math.min(pos.left, mainRect.right - tocFloat.offsetWidth - 10));
                const clampedTop = Math.max(mainRect.top + 10, Math.min(pos.top, mainRect.bottom - tocFloat.offsetHeight - 10));
                tocFloat.style.right = 'auto';
                tocFloat.style.left = clampedLeft + 'px';
                tocFloat.style.top = clampedTop + 'px';
            } else {
                tocFloat.style.right = 'auto';
                tocFloat.style.left = pos.left + 'px';
                tocFloat.style.top = pos.top + 'px';
            }
        }

        tocToggle.addEventListener('mousedown', (e) => {
            isDragging = true;
            hasMoved = false;
            tocFloat.dataset.isDragging = 'false';
            startX = e.clientX;
            startY = e.clientY;

            const rect = tocFloat.getBoundingClientRect();
            initialRight = window.innerWidth - rect.right;
            initialTop = rect.top;

            tocFloat.style.cursor = 'grabbing';
            tocToggle.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            // 如果移动距离超过5px，认为是拖动而非点击
            if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                hasMoved = true;
                tocFloat.dataset.isDragging = 'true';
            }

            const newRight = initialRight - deltaX;
            const newTop = initialTop + deltaY;

            // 获取主内容区域边界，限制在阅读区内
            const mainContent = document.getElementById('main-content');
            let clampedRight, clampedTop;

            if (mainContent) {
                const mainRect = mainContent.getBoundingClientRect();
                const newLeft = window.innerWidth - tocFloat.offsetWidth - newRight;

                // 限制在阅读区范围内
                const minLeft = mainRect.left + 10;
                const maxLeft = mainRect.right - tocFloat.offsetWidth - 10;
                const minTop = mainRect.top + 10;
                const maxTop = mainRect.bottom - tocFloat.offsetHeight - 10;

                const clampedLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));
                clampedTop = Math.max(minTop, Math.min(newTop, maxTop));

                tocFloat.style.right = 'auto';
                tocFloat.style.left = clampedLeft + 'px';
                tocFloat.style.top = clampedTop + 'px';
            } else {
                // 如果没有找到主内容区域，则限制在视口范围内
                const maxRight = window.innerWidth - tocFloat.offsetWidth - 10;
                const maxTop = window.innerHeight - tocFloat.offsetHeight - 10;

                clampedRight = Math.max(10, Math.min(newRight, maxRight));
                clampedTop = Math.max(70, Math.min(newTop, maxTop));

                tocFloat.style.right = clampedRight + 'px';
                tocFloat.style.top = clampedTop + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                tocFloat.style.cursor = 'grab';
                tocToggle.style.cursor = 'grab';

                // 延迟重置isDragging标志，确保click事件能检测到这个状态
                setTimeout(() => {
                    tocFloat.dataset.isDragging = 'false';
                }, 50);

                // 保存位置到localStorage
                const rect = tocFloat.getBoundingClientRect();
                localStorage.setItem('tocPosition', JSON.stringify({
                    left: rect.left,
                    top: rect.top
                }));
            }
        });
    }

    // 标题级数指示器
    const indicator = document.createElement('div');
    indicator.className = 'heading-level-indicator';
    document.body.appendChild(indicator);

    // 为所有标题添加鼠标悬停事件
    const allHeadings = articleContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
    allHeadings.forEach(heading => {
        heading.addEventListener('mouseenter', () => {
            const level = parseInt(heading.tagName.charAt(1));
            indicator.textContent = 'H' + level;
            indicator.setAttribute('data-level', level);

            // 先显示以获取尺寸
            indicator.style.visibility = 'hidden';
            indicator.style.opacity = '1';
            document.body.appendChild(indicator);

            const headingRect = heading.getBoundingClientRect();
            const indicatorRect = indicator.getBoundingClientRect();

            // 计算指示器位置：在标题最后一个字的右边
            const topPosition = headingRect.top + window.pageYOffset + (headingRect.height - indicatorRect.height) / 2;
            const leftPosition = headingRect.right - 50;

            indicator.style.visibility = 'visible';
            indicator.style.top = topPosition + 'px';
            indicator.style.left = leftPosition + 'px';

            indicator.classList.add('visible');
        });

        heading.addEventListener('mouseleave', () => {
            indicator.classList.remove('visible');
        });
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
    initTOC();
});
</script>
{{ end }}
